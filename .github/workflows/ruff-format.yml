name: ğŸ ç¨‹å¼ç¢¼æ ¼å¼èˆ‡å“è³ªæª¢æŸ¥

on:
  push:
    branches: [ main, master, dev/* ]
  pull_request:
    branches: [ main, master ]

jobs:
  ruff-check:
    name: Ruff ç¨‹å¼ç¢¼æª¢æŸ¥
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v6

      - name: è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: å®‰è£ uv
        run: pip install uv

      - name: åŸ·è¡Œ Ruff æ ¼å¼åŒ–èˆ‡ä¿®å¾©
        id: ruff
        # ä½¿ç”¨ || true ç¢ºä¿å³ä½¿æœ‰éŒ¯èª¤ä¹Ÿä¸ç«‹å³ä¸­æ–·ï¼Œä»¥ä¾¿å¾ŒçºŒæ­¥é©Ÿç”Ÿæˆå ±å‘Š
        run: |
          echo "Running ruff format..."
          FORMAT_LOG=$(uvx ruff@0.15.1 format . 2>&1 || true)
          echo "$FORMAT_LOG"
          
          echo "Running ruff check --fix..."
          CHECK_LOG=$(uvx ruff@0.15.1 check --fix . 2>&1 || true)
          echo "$CHECK_LOG"
          
          # å°‡æ—¥èªŒå„²å­˜åˆ°æª”æ¡ˆä¾›å¾ŒçºŒè…³æœ¬è®€å–
          echo "$FORMAT_LOG" > format.log
          echo "$CHECK_LOG" > check.log

      - name: ç”Ÿæˆå ±å‘Šèˆ‡è©•è«–
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            
            const formatLog = fs.readFileSync('format.log', 'utf8');
            const checkLog = fs.readFileSync('check.log', 'utf8');
            
            // --- è§£ææ ¼å¼åŒ–æ—¥èªŒ ---
            const formatMatch = formatLog.match(/(\d+) file(s)? reformatted/);
            const reformattedCount = formatMatch ? parseInt(formatMatch[1]) : 0;
            
            const unchangedMatch = formatLog.match(/(\d+) file(s)? left unchanged/);
            const unchangedCount = unchangedMatch ? parseInt(unchangedMatch[1]) : 0;
            
            // --- è§£ææª¢æŸ¥æ—¥èªŒ ---
            let fixedCount = 0;
            let remainingCount = 0;
            let totalErrors = 0;
            
            const errorMatch = checkLog.match(/Found (\d+) error/);
            if (errorMatch) {
                totalErrors = parseInt(errorMatch[1]);
                
                const fixedMatch = checkLog.match(/\((\d+) fixed/);
                if (fixedMatch) fixedCount = parseInt(fixedMatch[1]);
                
                const remainingMatch = checkLog.match(/, (\d+) remaining\)/);
                if (remainingMatch) {
                    remainingCount = parseInt(remainingMatch[1]);
                } else {
                    if (fixedCount === 0) remainingCount = totalErrors;
                }
            }
            
            // --- æ§‹å»ºå ±å‘Šå…§å®¹ ---
            let summary = '';
            let isSuccess = (reformattedCount === 0 && remainingCount === 0);
            
            if (isSuccess) {
                summary = '### âœ… All checks passed!';
            } else {
                summary = '### âš ï¸ ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å ±å‘Š\n\n';
                summary += '> ç™¼ç¾éƒ¨åˆ†æª”æ¡ˆéœ€è¦æ ¼å¼åŒ–æˆ–å­˜åœ¨ç¨‹å¼ç¢¼å•é¡Œï¼Œå»ºè­°åœ¨æœ¬åœ°åŸ·è¡Œ `ruff format .` å’Œ `ruff check --fix .`ã€‚\n\n';
                
                if (reformattedCount > 0) {
                    summary += `**ğŸ–Œï¸ æ ¼å¼åŒ–**ï¼š\`${reformattedCount}\` å€‹æª”æ¡ˆè¢«é‡æ–°æ ¼å¼åŒ–ï¼ˆæœªè®Šæ›´ï¼š${unchangedCount}ï¼‰\n`;
                } else {
                    summary += `**ğŸ–Œï¸ æ ¼å¼åŒ–**ï¼šâœ… ç„¡éœ€è®Šæ›´\n`;
                }
                
                if (totalErrors > 0) {
                    summary += `**ğŸ›¡ï¸ ç¨‹å¼ç¢¼æª¢æŸ¥**ï¼šç™¼ç¾ \`${totalErrors}\` å€‹å•é¡Œ\n`;
                    summary += `- ğŸ› ï¸ å·²è‡ªå‹•ä¿®å¾©ï¼š\`${fixedCount}\`\n`;
                    summary += `- âŒ å‰©é¤˜æœªä¿®å¾©ï¼š\`${remainingCount}\`\n`;
                } else {
                    summary += `**ğŸ›¡ï¸ ç¨‹å¼ç¢¼æª¢æŸ¥**ï¼šâœ… é€šé\n`;
                }
                
                if (remainingCount > 0) {
                    const logPreview = checkLog.length > 2000 ? checkLog.substring(0, 2000) + '\n...ï¼ˆæ—¥èªŒéé•·å·²æˆªæ–·ï¼‰' : checkLog;
                    summary += `\n<details><summary>ğŸ” éŒ¯èª¤è©³æƒ…</summary>\n\n\`\`\`text${logPreview}\n\n\`\`\`\n</details>`;
                }
            }
            
            // --- è¼¸å‡ºåˆ° Job Summary ---
            await core.summary.addRaw(summary).write();
            
            // --- PR è©•è«–ï¼ˆåƒ…åœ¨ PR äº‹ä»¶è§¸ç™¼æ™‚ï¼‰ ---
            if (context.eventName === 'pull_request') {
                const issue_number = context.issue.number;
                const owner = context.repo.owner;
                const repo = context.repo.repo;
                
                const comments = await github.rest.issues.listComments({
                    owner,
                    repo,
                    issue_number,
                });
                
                const botComment = comments.data.find(comment =>
                    comment.user.type === 'Bot' &&
                    (comment.body.includes('ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å ±å‘Š') || comment.body.includes('All checks passed'))
                );
                
                if (botComment) {
                    await github.rest.issues.updateComment({
                        owner,
                        repo,
                        comment_id: botComment.id,
                        body: summary
                    });
                } else {
                    if (!isSuccess) {
                        await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number,
                            body: summary
                        });
                    }
                }
            }
            
            // --- è¨­å®š Job ç‹€æ…‹ ---
            if (!isSuccess) {
                core.setFailed('ç¨‹å¼ç¢¼æ ¼å¼æˆ–å“è³ªæª¢æ¸¬æœªé€šéï¼Œè«‹æª¢æŸ¥å ±å‘Šã€‚');
            }
