# 本工作流用於標記並關閉長期不活躍的 Issue。
# 文件: https://github.com/actions/stale
name: 標記長期未活躍的 Issue

on:
  schedule:
    # 每天 UTC 00:30 執行（台北時間 08:30）
    - cron: '30 0 * * *'
  workflow_dispatch:
    inputs:
      dry-run:
        description: '僅預覽，不實際執行（Dry run mode）'
        required: false
        default: true
        type: boolean

jobs:
  stale:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v6

      - name: 確保標籤顏色正確
        # 僅在非 dry-run 模式下執行，避免預覽時報錯或產生副作用
        if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && !inputs.dry-run) }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create "status/stale" --color "EDEDED" --description "長期無活動的 Issue" || gh label edit "status/stale" --color "EDEDED" --description "長期無活動的 Issue"

      - uses: actions/stale@v10
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          operations-per-run: 200

          any-of-labels: 'type/fix,bug'

          # 不處理 PR
          days-before-pr-stale: -1
          days-before-pr-close: -1

          # 不活躍判定與關閉策略：先標記 stale，再延遲關閉
          days-before-issue-stale: 60
          days-before-issue-close: 30

          stale-issue-label: 'status/stale'
          stale-issue-message: |
            該 Issue 因較長時間無活動，已被標記為 `status/stale`。
            如無後續活動，將在一段時間後自動關閉。
            如仍需跟進，請回覆評論。

            ---

            This issue has been automatically marked as **status/stale** because it has not had any activity.
            It will be closed in a certain period of time if no further activity occurs.
            If this issue is still relevant, please leave a comment.

            ---

            この問題は長い間活動がないため、自動的に **status/stale** としてマークされました。
            今後活動がない場合、一定期間後に閉鎖されます。
            まだ関連性がある場合は、コメントを残してください。

          close-issue-message: |
            該 Issue 因長期無活動已自動關閉。
            如問題仍存在，歡迎補充重現資訊並重新開啟或新建 Issue。

            ---

            This issue has been automatically closed due to inactivity.
            If the problem still exists, feel free to reopen or create a new issue with updated information.

            ---

            この問題は長期にわたって活動がないため、自動的に閉鎖されました。
            問題がまだ存在する場合は、再現情報を追加して再開するか、新しい問題を作成してください。

          remove-stale-when-updated: true

          debug-only: ${{ github.event_name == 'workflow_dispatch' && inputs.dry-run }}
